---
title: "Sediment toxicity analysis"
author: ""
output: 
  html_document:
    code_folding: hide
self_contained: yes
---

```{r, echo = F}
library(knitr)
opts_chunk$set(warning = FALSE, message = FALSE, fig.path = 'figs/', dev.args = list(bg = 'transparent'), eval = F)
```

```{r setup, eval = T}
library(tidyverse)
library(GGally)
library(vegan)
library(ggdendro)
library(dendextend)
library(FactoMineR)
library(ggord)
library(mapview)
library(sf)

data(dat)

locs <- dat %>% 
  select(station, lon, lat)
evvr <- dat %>% 
  select(-toc, -tn, -fine, -depth, -lat, -lon)
```

The sediment toxicity dataset includes measurements at 155 coastal sites as part of the Bight 2008 sampling.  Twenty-eight measurements are available for each site: total organic carbon (`toc`), total nitrogen (`tn`), percent fine sediment (`fine`), amphipod survival (`amph_surv`), embryonic survival (`embr_surv`), and twenty-three metals.  This exploratory analysis was conducted to 1) evaluate correlations among measurements across the sites and 2) identify if sites could be characterized by similarities in characteristics.  The objective was to identify patterns among sites that may explain differences in survival rates or by location.  

This plot shows relationships among raw variables - outliers are present and variables occur at different scales.
```{r pairplot, fig.height = 9, fig.width = 9, eval = T}
pairs(evvr[, -1], gap = 0, cex = 0.5, col = 'grey')
```

This plot is identical to the above but shows the variables after removing outliers and standardizing the scales (substract the mean and divide by variance).  This 'clean' dataset was used for all analyses.
```{r pairplot_cln, fig.height = 9, fig.width = 9, eval = T}
dat_frm <- evvr %>%
  data.frame %>%
  filter(amph_surv > 30) %>%
  filter(Hg < 5) %>% 
  filter(Cr < 100) %>% 
  filter(Ba < 600) %>% 
  filter(Sb < 1.3) %>% 
  filter(Ag < 2) %>% 
  mutate(
    embr_surv = ifelse(is.na(embr_surv), mean(embr_surv, na.rm = TRUE), embr_surv), 
    Al = ifelse(is.na(Al), mean(Al, na.rm = TRUE), Al),
    Sb = ifelse(is.na(Sb), mean(Sb, na.rm = TRUE), Sb),
    As = ifelse(is.na(As), mean(As, na.rm = TRUE), As)
  ) %>%
  column_to_rownames('station') %>%
  decostand(method = 'standardize')

pairs(dat_frm, gap = 0, cex = 0.5, col = 'grey')
```

This dendrogram shows clustering of sites based on dissimilarity matrix of Euclidean distances for the measured variables.  Sites closer to each other at the terminal branches are more similar.  The tree was cut to identify site groupings within which relative values of the measured variables were similar. The site groupings from the dendrogram were overlayed with the pairs plot above to identify which variables were driving group patterns.  
```{r dendro, fig.width = 9, fig.height = 9, eval = T}
ngrps <- 4
grps <- kmeans(dat_frm, centers = ngrps, nstart = 10, iter.max = 30) %>% 
  .$cluster
cols <- mapviewGetOption("vector.palette")(ngrps)

colgrp <- data.frame(
  grps = c(1:ngrps), 
  cols = cols, 
  stringsAsFactors = F
)

colprs <- left_join(
    data.frame(grps = grps), colgrp, by = 'grps'
  )

pairs(dat_frm, gap = 0, cex = 0.5, col = as.character(colprs$cols))
```


```{r, fig.height = 9, fig.width = 9, eval = T}
toplo <- dat_frm %>% 
  mutate(grps = grps) %>% 
  left_join(colgrp, by = 'grps') %>% 
  mutate(grps = factor(grps)) %>% 
  gather('var', 'val', -grps, -cols)
mythm <- theme_bw(base_family = 'serif') +
  theme(
  legend.position = 'none', 
  strip.background = element_blank(), 
  plot.margin = margin(0, 2, 0, 2, "pt")
) 

colord <- unique(toplo[, c('grps', 'cols')])

ggplot(toplo, aes(x = grps, y = val)) + 
  geom_jitter(colour = toplo$cols, alpha = 0.5, width = 0.1) + 
  facet_wrap(~var, ncol = 5) + 
  mythm + 
  scale_y_continuous('Standardized measurements')
  
```

The site groupings from the dendrogram and variance among the measured variables were also evaluated using principal components analysis.  This ordination plot is similar to the dendrogram in that sites with similar characters are closer to each other in multivariate space.  In addition, the measured variables that are related to site groupings are also plotted as two-dimensional vectors.  The point cloud groupings in the plot were identified from the dendrogram cut above. The table shows significant correlations between the measured variables and dimensions of the PCA.
```{r ordiplot, fig.height = 7, fig.width = 7, eval = T}

ppp <- PCA(dat_frm, scale.unit = F, graph = F)

mythm <- theme_bw(base_family = 'serif') +
  theme(
  legend.position = 'none', 
  strip.background = element_blank(), 
  plot.margin = margin(0, 2, 0, 2, "pt")
) 

p1 <- ggord(ppp, grp_in = as.character(grps), vec_ext = 9, alpha = 0.8, size = 2, txt = 4, arrow = 0.2, cols = cols) + 
  mythm
p1

dimdesc(ppp, axes = c(1:2))
```

Finally, this map shows the site locations that are color-coded by the groupings from the dendrogram.  It can be used to evaluate spatial differences in the groupings.  
```{r, eval = T}
prstr <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0" 

toplo <- dat_frm %>% 
  rownames_to_column('station') %>% 
  mutate(station = as.numeric(station)) %>% 
  left_join(locs, by = 'station') %>% 
  mutate(Groups = grps) %>% 
  filter(!is.na(lon)) %>% 
  st_as_sf(coords = c('lon', 'lat'), crs = prstr)

mapview(toplo, zcol = 'Groups')
```

Conclusions: 

* Chemistry variables were all positively correlated: high organic carbon was associated with high nitrogen, high nitrogen was associated wtih high percent fines, etc. 
* Splitting the dendrogram into four groups creates relatively homogenous site groupings.  Most of the sites were in group 2, which is not strongly driven by any of the measured variables.  By contrast, groups 1, 4, and 5 are more distinct and can be explaind by the measured variables.
* Group 1 sites had low measurements for sediment chemistry.  It was not related to any of the survivorship measurements.
* Group 4 had the high embryonic survival and lowest amphipod survival.  This was not strongly linked to chemistry.
* Group 5 was strongly related to high amphipod survival and low embryonic survival. This was not strongly linked to chemistry.

The overall question needs to be identified. Below are some thoughts for consideration depending on the question.

* What sediment characteristics influence toxicity?  None of the sediment chemistry variables were related to survivorship, addtiional data will be needed to answer this question.  
* Is there redundancy in data collection efforts?  Chemistry measurements were correlated, so it may not be necessary to measure all of these variables.   
* Can the sampling sites be reduced?  It depends on the scale of interest - within bays or Bight wide.  Either way, more data are needed.

