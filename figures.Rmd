---
output: 
  bookdown::html_document2:
    code_folding: hide
---

```{r message = F, warning = F, results = 'hide', echo = F}
library(knitr)
opts_chunk$set(warning = FALSE, message = FALSE, fig.path = 'figs/', dev.args = list(bg = 'transparent'))

library(tidyverse)
library(GGally)
library(vegan)
library(ggdendro)
library(dendextend)
library(FactoMineR)
library(ggord)
library(mapview)
library(sf)
library(randomForest)
library(gridExtra)
library(here)
library(patchwork)

# get legend from an existing ggplot object
g_legend <- function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}

load(file = here('data', 'dat.RData'))

locs <- dat %>% 
  select(station, lon, lat) %>% 
  mutate(station = as.character(station))

# nutrients formatted data
# outlier removed, some variables transformed, values standardized
dat_frm <- dat %>% 
  select(station, depth, toc, tn, fine, amph_surv, embr_surv) %>% 
  select(-depth) %>% 
  data.frame %>% 
  filter(amph_surv > 30) %>% 
  # filter(tn < 0.4 & toc < 4 & amph_surv > 30)%>% 
  mutate(
    tn = log10(tn),  
    toc = log10(toc),
    fine = ifelse(is.na(fine), mean(fine, na.rm = TRUE), fine), 
    embr_surv = ifelse(is.na(embr_surv), mean(embr_surv, na.rm = TRUE), embr_surv)
  ) %>% 
  column_to_rownames('station') %>% 
  decostand(method = 'standardize')

# metals formatted data
# outliers removed, values standardized
dat_frm_mets <- dat %>% 
  select(-toc, -fine, -tn, -depth, -lat, -lon) %>% 
  data.frame %>%
  filter(amph_surv > 30) %>%
  filter(Hg < 5) %>% 
  filter(Cr < 100) %>% 
  filter(Ba < 600) %>% 
  filter(Sb < 1.3) %>% 
  filter(Ag < 2) %>% 
  mutate(
    embr_surv = ifelse(is.na(embr_surv), median(embr_surv, na.rm = TRUE), embr_surv), 
    Al = ifelse(is.na(Al), median(Al, na.rm = TRUE), Al),
    Sb = ifelse(is.na(Sb), median(Sb, na.rm = TRUE), Sb),
    As = ifelse(is.na(As), median(As, na.rm = TRUE), As)
  ) %>%
  column_to_rownames('station') %>%
  decostand(method = 'standardize')

# ggplot theme
mythm <- theme_bw(base_family = 'serif') +
  theme(
    legend.position = 'none', 
    strip.background = element_blank(), 
    plot.margin = ggplot2::margin(0, 2, 0, 2, "pt")
  ) 
```

# Figures {.tabset}

## Dendrogram

[download](figs/siteclsts.jpg)
```{r, results = 'hide'}

# cluster with euclidean dissim, ward grouping
dend <- dat_frm %>%  
  vegdist(method = 'euclidean') %>% 
  hclust(method = 'average')

# grouping vector
ngrps <- 5
grps <- cutree(dend, k = ngrps)
grps[grps == 3] <- 5
grps[grps == 4] <- 3
grps[grps == 5] <- 4

# color vector for groups
cols <- mapviewGetOption("vector.palette")(ngrps)
cols[4] <- cols[5]
cols[c(4,5)] <- 'orange'
colsd <- cols[c(1, 3, 2, 4, 5)]

p1 <- dend %>% 
  as.dendrogram %>% 
  set("labels_cex", 0.4) %>% 
  color_branches(k = ngrps, col = colsd) %>% 
  color_labels(k = ngrps, col = colsd)

jpeg(here('figs', 'siteclsts.jpg'), height = 4.5, width = 10, units = 'in', res = 500, family = 'serif')
plot(p1, ylab = 'Dissimilarity', xlab = 'Monitoring stations (155)')
dev.off()
```
```{r clstmap, fig.cap = "Dendrogram showing sites clustering based on a dissimilarity matrix of Euclidean distances for the measured variables. The tree was cut to identify site groupings within which relative values of the measured variables were similar. Sites closer to each other at the terminal branches are more similar. Sites distribution: group 1, 12 sites; group 3, 20; group 2, 107; group 4, 14.", out.width = "100%", fig.align = 'center'}
knitr::include_graphics(here('figs', 'siteclsts.jpg'))
```

## Pairs plot, nutrients

```{r, results = 'hide'}
cols <- cols[1:4]

toplo <- dat_frm %>% 
  mutate(Groups = as.character(grps))

p <- ggpairs(toplo, mapping = ggplot2::aes(fill = Groups, colour = Groups))

for (row in seq_len(p$nrow))
    for (col in seq_len(p$ncol))
        p[row, col] <- p[row, col] + scale_colour_manual(values = cols) + scale_fill_manual(values = cols)


# circlize_dendrogram(p1) 
jpeg(here('figs', 'prplts.jpg'), height = 7, width = 7, units = 'in', res = 500, family = 'serif')
p
dev.off()
```
```{r prplts, fig.cap = "A generalized pairs plot displaying paired combinations of categorical and quantitative/continuous variables (Emerson et al. 2013).", out.width = "70%", fig.align = 'center'}
knitr::include_graphics(here('figs', 'prplts.jpg'))
```

## PCA nutrients

```{r, results = 'hide'}
cols <- cols[1:4]

ppp <- PCA(dat_frm, scale.unit = F, graph = F)

p1 <- ggord(ppp, grp_in = as.character(grps), vec_ext = 3, alpha = 0.8, size = 2, txt = 4, arrow = 0.2, cols = cols) + 
  mythm

jpeg(here('figs', 'pcanuts.jpg'), height = 5, width = 5, units = 'in', res = 500, family = 'serif')
p1
dev.off()
```
```{r pcanuts, fig.cap = "Evaluating site groupings in Fig. 1 and the variance among measured variables using principal components analysis. Sites with similar characters are closer to each other in the ordination plot. Included are the measured variables related to site groupings as two-dimensional vectors.", out.width = "50%", fig.align = 'center'}
knitr::include_graphics(here('figs', 'pcanuts.jpg'))
```

## Metals group summaries

```{r, results = 'hide'}
# metals clustering
set.seed(1234)
ngrps <- 4
grps <- kmeans(dat_frm_mets, centers = ngrps, nstart = 10, iter.max = 30) %>% 
  .$cluster

# metals cluster colors
cols <- mapviewGetOption("vector.palette")(ngrps)
cols[4] <- 'orange'
colgrp <- data.frame(
  grps = c(1:ngrps), 
  cols = cols, 
  stringsAsFactors = F
)

# data for summary plot
toplo <- dat_frm_mets %>% 
  mutate(grps = grps) %>% 
  left_join(colgrp, by = 'grps') %>% 
  mutate(grps = factor(grps)) %>% 
  gather('var', 'val', -grps, -cols) %>% 
  group_by(grps, cols, var) %>% 
  summarise(
    med = quantile(val, probs = 0.5, na.rm = T),
    min = quantile(val, probs = 0.05, na.rm = T),
    max = quantile(val, probs = 0.95, na.rm = T)
  ) %>% 
  ungroup() %>% 
  mutate(var = fct_relevel(var, 'amph_surv', 'embr_surv'))

p <- ggplot(toplo, aes(x = grps, y = med)) + 
  geom_errorbar(aes(ymin = min, ymax = max), width = 0) +
  geom_point(pch = 21, fill = toplo$cols, size = 3) +
  facet_wrap(~var, ncol = 5) + 
  mythm + 
  scale_y_continuous('Standardized measurements') + 
  scale_x_discrete('Groups')

jpeg(here('figs', 'metsums.jpg'), height = 7, width = 4.5, units = 'in', res = 500, family = 'serif')
p
dev.off()
```
```{r metsums, fig.cap = "Summaries (median and 5th/95th percentiles) of toxicity measurements and metal concentrations among the groups defined with cluster analysis.  The y-axis is standardized for relative comparisons among groups and constituents.", out.width = "50%", fig.align = 'center'}
knitr::include_graphics(here('figs', 'metsums.jpg'))
```

## Metals PCA

```{r, results = 'hide'}
ppp <- PCA(dat_frm_mets, scale.unit = F, graph = F)

mythm2 <- theme_bw(base_family = 'serif') +
  theme(
    legend.position = 'none', 
    strip.background = element_blank()
  ) 

p1 <- ggord(ppp, grp_in = as.character(grps), vec_ext = 9, alpha = 0.8, size = 2, txt = 4, arrow = 0.2, cols = cols, coord_fix = F) + 
  mythm2

p2 <- ggord(ppp, grp_in = as.character(grps), axes = c('2', '3'), vec_ext = 9, alpha = 0.8, size = 2, txt = 4, arrow = 0.2, cols = cols, coord_fix = F) + 
  mythm2

p3 <- ggord(ppp, grp_in = as.character(grps), axes = c('1', '3'), vec_ext = 9, alpha = 0.8, size = 2, txt = 4, arrow = 0.2, cols = cols, coord_fix = F) 
pleg <- g_legend(p3)
p3 <- p3 + mythm2

jpeg(here('figs', 'pcamets.jpg'), height = 11, width = 5.5, units = 'in', res = 500, family = 'serif')
{p1 + p2 + p3 + plot_layout(ncol = 1)} - 
    pleg + plot_layout(ncol = 2, widths = c(1, 0.2))
dev.off()
```
```{r pcamets, fig.cap = "Site groupings from the k-means clusters and variance among the measured variables using principal components analysis. The first three PCA axes are shown, with each plot showing a different combination of axes.", out.width = "45%", fig.align = 'center'}
knitr::include_graphics(here('figs', 'pcamets.jpg'))
```

## Metals variable importance

```{r, results = 'hide'}
tomod <- dat_frm_mets %>% 
  mutate(grps = factor(grps))

set.seed(123)
tmp <- randomForest(grps ~ .,
                    data = tomod, 
                    importance = TRUE, 
                    ntree = 1000, na.action = na.omit)

# plos for variable importance groupings 
plos <- tmp$importance %>% 
  as.data.frame %>%
  rownames_to_column('var') %>% 
  dplyr::select(-MeanDecreaseAccuracy, -MeanDecreaseGini) %>% 
  gather('grp', 'importance', -var) %>% 
  group_by(grp) %>% 
  nest %>% 
  mutate(
    implo = pmap(list(as.character(grp), data), function(grp, data){

      colfl <- colgrp %>% 
        filter(grps %in% grp) %>% 
        pull(cols)
      
      toplo <- data %>% 
        arrange(-importance) %>% 
        .[1:10, ] %>% 
        mutate(var = factor(var, levels = var))
      
      p <- ggplot(toplo, aes(x = var, y = importance)) + 
        geom_segment(aes(xend = var, yend = 0)) +
        geom_point(fill = colfl, pch = 21, size = 3) + 
        theme_bw() + 
        theme(
          axis.title.x = element_blank(), 
          axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
          axis.title.y = element_blank()
        ) + 
        ggtitle(grp) + 
        scale_y_continuous(limits = c(0, 0.17))
      
      
      return(p)
      
    })
  )

# variable importance for toxicity 
plos2 <- dat_frm_mets %>% 
  gather('var', 'val', amph_surv, embr_surv) %>% 
  group_by(var) %>% 
  nest %>% 
  mutate(
    implo = pmap(list(var, data), function(var, data){

      tmp <- randomForest(val ~ .,
                          data = data, 
                          importance = TRUE, 
                          ntree = 1000, na.action = na.omit)
      
      toplo <- tmp$importance %>% 
        as.data.frame %>%
        rownames_to_column('var') %>% 
        dplyr::select(-IncNodePurity) %>% 
        rename(importance = `%IncMSE`) %>% 
        arrange(-importance) %>% 
        .[1:10, ] %>% 
        mutate(var = factor(var, levels = var))
      
      p <- ggplot(toplo, aes(x = var, y = importance)) + 
        geom_segment(aes(xend = var, yend = 0)) +
        geom_point(fill = 'grey', pch = 21, size = 3) + 
        theme_bw() + 
        theme(
          axis.title.x = element_blank(), 
          axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
          axis.title.y = element_blank()
        ) + 
        ggtitle(var)  + 
        scale_y_continuous(limits = c(0, 0.41))
    
      return(p)
      
    })
  )

p1 <- plos$implo[[1]]
p2 <- plos$implo[[2]]
p3 <- plos$implo[[3]]
p4 <- plos$implo[[4]]
p5 <- plos2$implo[[1]]
p6 <- plos2$implo[[2]]

jpeg(here('figs', 'grpimp.jpg'), height = 7.5, width = 7.5, units = 'in', res = 500, family = 'serif')
grid.arrange(
  arrangeGrob(p1, p2, p3, p4, ncol = 4, top = '(a) Group variable importance'),
  arrangeGrob(p5, p6, ncol = 2, top = '(b) Toxicity variable importance'),
  left = grid::textGrob('Importance (% increase MSE)', rot = 90), 
  ncol = 1, heights = c(1, 1)
  )
dev.off()
```
```{r grpimp, fig.cap = "Variable importance estimates from random forest models describing (a) group clusters pr (b) differences among sites for toxicity test results.  Importance estimates are based on the increase in mean square error (MSE) for excluding a specific variable from the random forest model.", out.width = "60%", fig.align = 'center'}
knitr::include_graphics(here('figs', 'grpimp.jpg'))
```
